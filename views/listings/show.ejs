<%-layout("/layouts/boilerplate")%>
<div class="row" style="background-color: antiquewhite;">
  <div class="col-8 offset-2 mt-3">
  </div>
  <div class="card col-6 offset-3 show-card listing-card">
    <h3><%=listing.title%></h3>
    
    <img src="<%=listing.image.url%>" class="card-img-top show-img" alt="listing_image">
    <div class="card-body">
      <br> 
      <% if (listing.owner && listing.owner.username) { %>
        <p class="card-text">Owned by - <i><%= listing.owner.username %></i></p>
      <% } else { %>
        <p class="card-text">Owned by - <i>Unknown</i></p>
      <% } %>
      
      <p class="card-text"><%= listing.description %></p>
      <p class="card-text">&#x20B9; <%=listing.price.toLocaleString("en-in")%></p>
      <p class="card-text"><%=listing.location%></p>
      <p class="card-text"><%=listing.country%></p>
    </div>

    <!-- booking details -->
    <div class="card-body bg-light border-top border-bottom py-4 my-3">
      <div class="text-center">
        <h4 class="mb-3">Ready for an amazing stay?</h4>
        
        <!-- Availability status -->
        <div id="availability-status" class="mb-3">
          <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2">Checking availability...</span>
          </div>
        </div>
        
        <% if (currUser) { %>
          <a href="/listings/<%= listing._id %>/book" id="book-now-btn" class="btn btn-success btn-lg shadow-sm">
            <i class="fas fa-calendar-check me-2"></i>Book Now
          </a>
          <a href="/listings/availability" class="btn btn-outline-primary btn-sm ms-2">
            <i class="fas fa-list me-1"></i>View All Available Listings
          </a>
        <% } else { %>
          <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            Please <a href="/login" class="alert-link">login</a> to book this place.
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Unavailable Modal -->
  <div class="modal fade" id="unavailableModal" tabindex="-1" aria-labelledby="unavailableModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="unavailableModalLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>
            This listing is not available
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>We're sorry, but this listing is not available for the selected dates.</p>
          <h6 class="mb-3">Booked dates:</h6>
          <div id="booked-dates-list" class="list-group mb-3">
            <div class="d-flex justify-content-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span class="ms-2">Loading booked dates...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <a href="/listings/availability" class="btn btn-primary">
            <i class="fas fa-search me-1"></i>Find Available Listings
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <% if (currUser && listing.owner && listing.owner._id.equals(currUser._id)) { %>
    <div class="btns">
      <a href="/listings/<%=listing._id%>/edit" class="btn btn-dark col-1 offset-3 edit-btn">Edit</a>
      <br><br>
      <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE">
        <button class="btn btn-dark offset-5">Delete</button>
      </form>
    </div>
  <% } %>

 <script>
  document.addEventListener('DOMContentLoaded', async function() {
    // Check if user is logged in (this will be rendered server-side)
    const isLoggedIn = window.currUser ? true : false;
    
    if (isLoggedIn) {
      const listingId = '<%= listing._id %>';
      const availabilityStatus = document.getElementById('availability-status');
      const bookNowBtn = document.getElementById('book-now-btn');
      const unavailableModal = new bootstrap.Modal(document.getElementById('unavailableModal'));
      const bookedDatesList = document.getElementById('booked-dates-list');
      
      try {
        // Check immediate availability (today to tomorrow)
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const response = await fetch('/check-availability', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            listingId: listingId,
            checkIn: today.toISOString().split('T')[0],
            checkOut: tomorrow.toISOString().split('T')[0]
          })
        });
        
        const data = await response.json();
        
        // Update availability status
        if (data.available) {
          availabilityStatus.innerHTML = `
            <div class="alert alert-success" role="alert">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Available for booking!</strong> Book now to secure your stay.
            </div>
          `;
        } else {
          availabilityStatus.innerHTML = `
            <div class="alert alert-warning" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Currently unavailable</strong> for immediate booking.
              <button type="button" class="btn btn-link p-0 ms-2" id="show-booked-dates">See booked dates</button>
            </div>
          `;
          
          // Add event listener to show booked dates
          document.getElementById('show-booked-dates').addEventListener('click', function() {
            // Fetch booked dates
            fetchBookedDates();
            unavailableModal.show();
          });
        }
        
        // Add event listener to book now button
        bookNowBtn.addEventListener('click', async function(e) {
          if (!data.available) {
            e.preventDefault();
            fetchBookedDates();
            unavailableModal.show();
          }
        });
      } catch (err) {
        console.error('Error checking availability:', err);
        availabilityStatus.innerHTML = `
          <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Error checking availability.</strong> Please try again later.
          </div>
        `;
      }
      
      // Function to fetch and display booked dates
      async function fetchBookedDates() {
        try {
          // Get today's date for reference
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          // This would be a real API call in production
          // For now, we'll simulate it with a timeout
          setTimeout(() => {
            // Clear previous entries
            bookedDatesList.innerHTML = '';
            
            // Add some sample booked dates (in a real app, these would come from the server)
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            const nextMonth = new Date(today);
            nextMonth.setDate(nextMonth.getDate() + 30);
            
            const bookedDates = [
              { start: today, end: tomorrow },
              { start: nextWeek, end: new Date(nextWeek.getTime() + (3 * 24 * 60 * 60 * 1000)) },
              { start: nextMonth, end: new Date(nextMonth.getTime() + (5 * 24 * 60 * 60 * 1000)) }
            ];
            
            bookedDates.forEach(booking => {
              const startDate = booking.start.toLocaleDateString();
              const endDate = booking.end.toLocaleDateString();
              
              const listItem = document.createElement('div');
              listItem.className = 'list-group-item';
              listItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-calendar-times text-danger me-2"></i>
                    ${startDate} to ${endDate}
                  </div>
                  <span class="badge bg-danger rounded-pill">${Math.round((booking.end - booking.start) / (24 * 60 * 60 * 1000))} nights</span>
                </div>
              `;
              
              bookedDatesList.appendChild(listItem);
            });
          }, 500);
        } catch (err) {
          console.error('Error fetching booked dates:', err);
          bookedDatesList.innerHTML = '<div class="alert alert-danger">Error loading booked dates</div>';
        }
      }
    }
  });
</script>

  <div class="col-8 offset-3 mb-3">
    <hr> 
    <% if(currUser) { %>
      <h4>Leave a Review</h4>
      <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
        <label for="rating" class="form-label">Rating</label>
        <fieldset class="starability-slot">
          <input type="radio" id="first-rate1" name="review[rating]" value="1" />
          <label for="first-rate1" title="Terrible">1 star</label>
          <input type="radio" id="first-rate2" name="review[rating]" value="2" />
          <label for="first-rate2" title="Not good">2 stars</label>
          <input type="radio" id="first-rate3" name="review[rating]" value="3" />
          <label for="first-rate3" title="Average">3 stars</label>
          <input type="radio" id="first-rate4" name="review[rating]" value="4" />
          <label for="first-rate4" title="Very good">4 stars</label>
          <input type="radio" id="first-rate5" name="review[rating]" value="5" />
          <label for="first-rate5" title="Amazing">5 stars</label>
        </fieldset>

        <div class="mb-3 mt-3">
          <h4>Comments</h4>
          <label for="comment" class="form-label"></label>
          <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control" required></textarea>
          <div class="invalid-feedback">Please submit some comments for feedback</div>
        </div>
        <button class="btn btn-outline-dark">Submit</button>
      </form>
      <hr>
    <% } %>
    
    <p><b>All reviews</b></p>
    
    <div class="row">
      <% for(review of listing.reviews) { %>
        <div class="card col-5 ms-3 mb-3">
          <div class="card-body">
            <% if (review.author && review.author.username) { %>
              <h5 class="card-title">@<%= review.author.username %></h5>
            <% } else { %>
              <h5 class="card-title">Anonymous User</h5>
            <% } %>
            <p class="starability-result card-text" data-rating="<%= review.rating %>"></p>
            <br>
            <p class="card-text"><%= review.comment %></p>
          </div>
          <% if (currUser && review.author && review.author._id.equals(currUser._id)) { %>
            <form class="mb-3" method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
              <button class="btn btn-sm btn-dark">Delete</button>
            </form>
          <% } %>
        </div>
      <% } %> 
    </div>
  </div>
</div>